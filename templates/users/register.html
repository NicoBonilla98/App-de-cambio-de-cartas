{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-6 col-md-8 col-sm-12">
            <div class="card shadow p-4 bg-white rounded">
                <div class="card-body">
                    <h2 class="card-title text-center mb-4">Registro</h2>
                    <form method="post" id="registerForm">
                        {% csrf_token %}

                        <!-- Username -->
                        <div class="mb-3">
                            <label for="id_username" class="form-label">Nombre de usuario</label>
                            <input type="text" name="username" maxlength="50" autofocus id="id_username"
                                class="form-control">
                            <div id="usernameEmpty" class="text-danger mt-1" style="display: none;">
                                ❌ El nombre de usuario no puede estar vacío.
                            </div>
                            <div id="usernameError" class="text-danger mt-1" style="display: none;">
                                ❌ Solo se permiten letras, números y '_', '-', '.'
                            </div>
                        </div>

                        <!-- Email -->
                        <div class="mb-3">
                            <label for="id_email" class="form-label">Correo electrónico</label>
                            <input type="email" name="email" maxlength="320" id="id_email" class="form-control">
                            <div id="emailEmpty" class="text-danger mt-1" style="display: none;">
                                ❌ El correo no puede estar vacío.
                            </div>
                            <div id="emailError" class="text-danger mt-1" style="display: none;">
                                ❌ El formato del correo no es válido.
                            </div>
                        </div>

                        <!-- Password -->
                        <div class="mb-3">
                            <label for="id_password1" class="form-label">Contraseña</label>
                            <input type="password" name="password1" autocomplete="new-password" id="id_password1"
                                class="form-control">
                            <ul id="passwordEmpty" class="text-danger mt-1" style="display: none;">
                                <li>❌ La contraseña no puede estar vacía.</li>
                                <li id="passTooSimilar" style="display: none;">❌ Tu contraseña no puede ser demasiado
                                    similar a tu información personal.</li>
                                <li id="passTooShort" style="display: none;">❌ Debe contener al menos 8 caracteres.</li>
                                <li id="passNumericOnly" style="display: none;">❌ No puede ser completamente numérica.
                                </li>
                            </ul>
                        </div>

                        <!-- Confirm Password -->
                        <div class="mb-3">
                            <label for="id_password2" class="form-label">Confirmar contraseña</label>
                            <input type="password" name="password2" autocomplete="new-password" id="id_password2"
                                class="form-control">
                            <div id="password2Empty" class="text-danger mt-1" style="display: none;">
                                ❌ Este campo no puede estar vacío.
                            </div>
                            <div id="password2Error" class="text-danger mt-1" style="display: none;">
                                ❌ Las contraseñas no coinciden.
                            </div>
                        </div>

                        <div class="text-center">
                            <button type="submit" class="btn btn-primary">Registrarse</button>
                            <p>¿Tienes una cuenta? <a href="{% url 'login' %}">Inicia sesión</a>.</p>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('registerForm');
        const username = document.getElementById('id_username');
        const email = document.getElementById('id_email');
        const password1 = document.getElementById('id_password1');
        const password2 = document.getElementById('id_password2');

        const show = (id) => document.getElementById(id).style.display = 'block';
        const hide = (id) => document.getElementById(id).style.display = 'none';
        const shake = (el) => {
            el.classList.add('input-error');
            setTimeout(() => el.classList.remove('input-error'), 1000);
        };

        function validatePasswordField() {
            const password = password1.value.trim();
            const usernameVal = username.value.trim();
            const emailVal = email.value.trim();

            let hasError = false;

            const emptyError = document.getElementById('passwordEmpty').children[0];
            const similarError = document.getElementById('passTooSimilar');
            const lengthError = document.getElementById('passTooShort');
            const numericError = document.getElementById('passNumericOnly');

            if (!password) {
                emptyError.style.display = 'list-item';
                hasError = true;
            } else {
                emptyError.style.display = 'none';
            }

            if (password && (usernameVal.includes(password) || emailVal.includes(password))) {
                similarError.style.display = 'list-item';
                hasError = true;
            } else {
                similarError.style.display = 'none';
            }

            if (password && password.length < 8) {
                lengthError.style.display = 'list-item';
                hasError = true;
            } else {
                lengthError.style.display = 'none';
            }

            if (password && /^\d+$/.test(password)) {
                numericError.style.display = 'list-item';
                hasError = true;
            } else {
                numericError.style.display = 'none';
            }

            const ul = document.getElementById('passwordEmpty');
            ul.style.display = hasError ? 'block' : 'none';

            if (hasError) shake(password1);
            return !hasError;
        }

        function validateField(field) {
            const value = field.input.value.trim();
            const emptyDiv = document.getElementById(field.emptyId);
            const errorDiv = field.errorId ? document.getElementById(field.errorId) : null;

            let isValid = true;

            if (!value) {
                show(field.emptyId);
                if (errorDiv) hide(field.errorId);
                shake(field.input);
                isValid = false;
            } else if (!field.validate(value)) {
                if (field.errorId) show(field.errorId);
                hide(field.emptyId);
                shake(field.input);
                isValid = false;
            } else {
                hide(field.emptyId);
                if (errorDiv) hide(field.errorId);
            }

            return isValid;
        }

        const fields = [
            { input: username, emptyId: 'usernameEmpty', errorId: 'usernameError', validate: val => /^[\w.-]+$/.test(val) },
            { input: email, emptyId: 'emailEmpty', errorId: 'emailError', validate: val => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val) },
            { input: password2, emptyId: 'password2Empty', errorId: 'password2Error', validate: () => password1.value === password2.value }
        ];

        fields.forEach(field => {
            if (field.input.id === 'id_email') {
                field.input.addEventListener('blur', () => validateField(field));
            } else {
                field.input.addEventListener('input', () => validateField(field));
            }
        });

        password1.addEventListener('input', validatePasswordField);

        form.addEventListener('submit', function (e) {
            let formValid = true;

            if (!validatePasswordField()) formValid = false;
            fields.forEach(field => {
                if (!validateField(field)) formValid = false;
            });

            if (!formValid) e.preventDefault();
        });
    });
</script>
{% endblock %}